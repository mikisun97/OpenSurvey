<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.survey.mapper.CommentMapper">

    <!-- 댓글 ResultMap -->
    <resultMap id="commentResultMap" type="egovframework.survey.vo.CommentVO">
        <id property="commentNo" column="COMMENT_NO"/>
        <result property="nttId" column="NTT_ID"/>
        <result property="commentCn" column="COMMENT_CN"/>
        <result property="commentWriterId" column="COMMENT_WRITER_ID"/>
        <result property="commentWriterNm" column="COMMENT_WRITER_NM"/>
        <result property="commentPassword" column="COMMENT_PASSWORD"/>
        <result property="useAt" column="USE_AT"/>
        <result property="frstRegisterId" column="FRST_REGISTER_ID"/>
        <result property="frstRegistPnttm" column="FRST_REGIST_PNTTM"/>
        <result property="lastUpdusrId" column="LAST_UPDUSR_ID"/>
        <result property="lastUpdtPnttm" column="LAST_UPDT_PNTTM"/>
    </resultMap>

    <!-- 댓글 목록 조회 -->
    <select id="selectCommentList" resultMap="commentResultMap">
        SELECT 
            COMMENT_NO,
            NTT_ID,
            COMMENT_CN,
            COMMENT_WRITER_ID,
            COMMENT_WRITER_NM,
            COMMENT_PASSWORD,
            USE_AT,
            FRST_REGISTER_ID,
            FRST_REGIST_PNTTM,
            LAST_UPDUSR_ID,
            LAST_UPDT_PNTTM
        FROM COMTNCOMMENT
        WHERE NTT_ID = #{param2,jdbcType=BIGINT}
        AND USE_AT = 'Y'
        ORDER BY FRST_REGIST_PNTTM ASC
    </select>

    <!-- 댓글 총 개수 조회 -->
    <select id="selectCommentListTotCnt" resultType="int">
        SELECT COUNT(*)
        FROM COMTNCOMMENT
        WHERE NTT_ID = #{param2,jdbcType=BIGINT}
        AND USE_AT = 'Y'
    </select>

    <!-- 댓글 상세 조회 -->
    <select id="selectCommentDetail" parameterType="long" resultMap="commentResultMap">
        SELECT 
            COMMENT_NO,
            NTT_ID,
            COMMENT_CN,
            COMMENT_WRITER_ID,
            COMMENT_WRITER_NM,
            COMMENT_PASSWORD,
            USE_AT,
            FRST_REGISTER_ID,
            FRST_REGIST_PNTTM,
            LAST_UPDUSR_ID,
            LAST_UPDT_PNTTM
        FROM COMTNCOMMENT
        WHERE COMMENT_NO = #{commentNo,jdbcType=BIGINT}
    </select>

    <!-- 댓글 등록 -->
    <insert id="insertComment" parameterType="egovframework.survey.vo.CommentVO" useGeneratedKeys="true" keyProperty="commentNo">
        INSERT INTO COMTNCOMMENT (
            NTT_ID,
            COMMENT_CN,
            COMMENT_WRITER_ID,
            COMMENT_WRITER_NM,
            COMMENT_PASSWORD,
            USE_AT,
            FRST_REGISTER_ID,
            FRST_REGIST_PNTTM
        ) VALUES (
            #{nttId,jdbcType=BIGINT},
            #{commentCn,jdbcType=VARCHAR},
            #{commentWriterId,jdbcType=VARCHAR},
            #{commentWriterNm,jdbcType=VARCHAR},
            #{commentPassword,jdbcType=VARCHAR},
            COALESCE(#{useAt,jdbcType=VARCHAR}, 'Y'),
            #{frstRegisterId,jdbcType=VARCHAR},
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 댓글 수정 -->
    <update id="updateComment" parameterType="egovframework.survey.vo.CommentVO">
        UPDATE COMTNCOMMENT SET
            COMMENT_CN = #{commentCn,jdbcType=VARCHAR},
            LAST_UPDUSR_ID = #{lastUpdusrId,jdbcType=VARCHAR},
            LAST_UPDT_PNTTM = CURRENT_TIMESTAMP
        WHERE COMMENT_NO = #{commentNo,jdbcType=BIGINT}
    </update>

    <!-- 댓글 삭제 -->
    <update id="deleteComment" parameterType="long">
        UPDATE COMTNCOMMENT SET 
            USE_AT = 'N',
            LAST_UPDT_PNTTM = CURRENT_TIMESTAMP
        WHERE COMMENT_NO = #{commentNo,jdbcType=BIGINT}
    </update>

    <!-- 게시글의 모든 댓글 삭제 -->
    <update id="deleteCommentAll" parameterType="long">
        UPDATE COMTNCOMMENT SET 
            USE_AT = 'N',
            LAST_UPDT_PNTTM = CURRENT_TIMESTAMP
        WHERE NTT_ID = #{nttId,jdbcType=BIGINT}
    </update>

</mapper> 