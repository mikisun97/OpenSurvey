<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.survey.mapper.UserMapper">
    
    <!-- 업무사용자 ID로 사용자 정보 조회 (전자정부 표준) -->
    <select id="selectUserById" parameterType="string" resultType="egovframework.survey.vo.EmplyrInfoVO">
        SELECT
            u.ESNTL_ID as esntlId,
            u.EMPLYR_ID as emplyrId,
            u.USER_NM as userNm,
            u.PASSWORD as password,
            u.HOUSE_ADRES as houseAdres,
            u.DETAIL_ADRES as detailAdres,
            u.ZIP_CODE as zipCode,
            u.OFFM_TELNO as offmTelno,
            u.MBTLNUM as mbtlnum,
            u.EMAIL_ADRES as emailAdres,
            u.OFCPS_NM as ofcpsNm,
            u.HOUSE_END_TELNO as houseEndTelno,
            u.GROUP_ID as groupId,
            u.PSTINST_CODE as pstinstCode,
            u.EMPLYR_STTUS_CODE as emplyrSttusCode,
            u.FRST_REGIST_PNTTM as frstRegistPnttm,
            u.FRST_REGISTER_ID as frstRegisterId,
            u.LAST_UPDT_PNTTM as lastUpdtPnttm,
            u.LAST_UPDUSR_ID as lastUpdusrId,
            s.AUTHOR_CODE as authorCode,
            a.AUTHOR_NM as authorNm,
            s.MBER_TY_CODE as mberTyCode
        FROM COMTNEMPLYRINFO u
        LEFT JOIN COMTNEMPLYRSCRTYESTBS s ON u.ESNTL_ID = s.SCRTY_DTRMN_TRGET_ID
        LEFT JOIN COMTNAUTHORINFO a ON s.AUTHOR_CODE = a.AUTHOR_CODE
        WHERE u.EMPLYR_ID = #{emplyrId}
        AND u.EMPLYR_STTUS_CODE = 'A'
    </select>
    
    <!-- 업무사용자 ID와 비밀번호로 사용자 정보 조회 (로그인용) -->
    <select id="selectUserByIdAndPassword" resultType="egovframework.survey.vo.EmplyrInfoVO">
        SELECT
            u.ESNTL_ID as esntlId,
            u.EMPLYR_ID as emplyrId,
            u.USER_NM as userNm,
            u.PASSWORD as password,
            u.HOUSE_ADRES as houseAdres,
            u.DETAIL_ADRES as detailAdres,
            u.ZIP_CODE as zipCode,
            u.OFFM_TELNO as offmTelno,
            u.MBTLNUM as mbtlnum,
            u.EMAIL_ADRES as emailAdres,
            u.OFCPS_NM as ofcpsNm,
            u.HOUSE_END_TELNO as houseEndTelno,
            u.GROUP_ID as groupId,
            u.PSTINST_CODE as pstinstCode,
            u.EMPLYR_STTUS_CODE as emplyrSttusCode,
            u.FRST_REGIST_PNTTM as frstRegistPnttm,
            u.FRST_REGISTER_ID as frstRegisterId,
            u.LAST_UPDT_PNTTM as lastUpdtPnttm,
            u.LAST_UPDUSR_ID as lastUpdusrId,
            s.AUTHOR_CODE as authorCode,
            a.AUTHOR_NM as authorNm,
            s.MBER_TY_CODE as mberTyCode
        FROM COMTNEMPLYRINFO u
        LEFT JOIN COMTNEMPLYRSCRTYESTBS s ON u.ESNTL_ID = s.SCRTY_DTRMN_TRGET_ID
        LEFT JOIN COMTNAUTHORINFO a ON s.AUTHOR_CODE = a.AUTHOR_CODE
        WHERE u.EMPLYR_ID = #{emplyrId}
        AND u.PASSWORD = #{password}
        AND u.EMPLYR_STTUS_CODE = 'A'
    </select>
    
    <!-- 사용자 권한명 조회 -->
    <select id="selectAuthorityNm" parameterType="string" resultType="string">
        SELECT a.AUTHOR_NM
        FROM COMTNAUTHORINFO a
        INNER JOIN COMTNEMPLYRSCRTYESTBS s ON a.AUTHOR_CODE = s.AUTHOR_CODE
        INNER JOIN COMTNEMPLYRINFO u ON s.SCRTY_DTRMN_TRGET_ID = u.ESNTL_ID
        WHERE u.EMPLYR_ID = #{emplyrId}
        AND u.EMPLYR_STTUS_CODE = 'A'
    </select>
    
    <!-- 업무사용자 정보 등록 -->
    <insert id="insertEmplyrInfo" parameterType="egovframework.survey.vo.EmplyrInfoVO">
        INSERT INTO COMTNEMPLYRINFO (
            ESNTL_ID,
            EMPLYR_ID,
            USER_NM,
            PASSWORD,
            HOUSE_ADRES,
            DETAIL_ADRES,
            ZIP_CODE,
            OFFM_TELNO,
            MBTLNUM,
            EMAIL_ADRES,
            OFCPS_NM,
            HOUSE_END_TELNO,
            GROUP_ID,
            PSTINST_CODE,
            EMPLYR_STTUS_CODE,
            FRST_REGIST_PNTTM,
            FRST_REGISTER_ID
        ) VALUES (
            #{esntlId},
            #{emplyrId},
            #{userNm},
            #{password},
            #{houseAdres},
            #{detailAdres},
            #{zipCode},
            #{offmTelno},
            #{mbtlnum},
            #{emailAdres},
            #{ofcpsNm},
            #{houseEndTelno},
            #{groupId},
            #{pstinstCode},
            #{emplyrSttusCode},
            CURRENT_TIMESTAMP,
            #{frstRegisterId}
        )
    </insert>
    
    <!-- 업무사용자 정보 수정 -->
    <update id="updateEmplyrInfo" parameterType="egovframework.survey.vo.EmplyrInfoVO">
        UPDATE COMTNEMPLYRINFO SET
            USER_NM = #{userNm},
            HOUSE_ADRES = #{houseAdres},
            DETAIL_ADRES = #{detailAdres},
            ZIP_CODE = #{zipCode},
            OFFM_TELNO = #{offmTelno},
            MBTLNUM = #{mbtlnum},
            EMAIL_ADRES = #{emailAdres},
            OFCPS_NM = #{ofcpsNm},
            HOUSE_END_TELNO = #{houseEndTelno},
            GROUP_ID = #{groupId},
            PSTINST_CODE = #{pstinstCode},
            EMPLYR_STTUS_CODE = #{emplyrSttusCode},
            LAST_UPDT_PNTTM = CURRENT_TIMESTAMP,
            LAST_UPDUSR_ID = #{lastUpdusrId}
        WHERE ESNTL_ID = #{esntlId}
    </update>
    
    <!-- 업무사용자 비밀번호 수정 -->
    <update id="updateEmplyrPassword" parameterType="map">
        UPDATE COMTNEMPLYRINFO SET
            PASSWORD = #{password},
            LAST_UPDT_PNTTM = CURRENT_TIMESTAMP,
            LAST_UPDUSR_ID = #{lastUpdusrId}
        WHERE ESNTL_ID = #{esntlId}
    </update>
    
    <!-- 업무사용자 상태 수정 -->
    <update id="updateEmplyrStatus" parameterType="map">
        UPDATE COMTNEMPLYRINFO SET
            EMPLYR_STTUS_CODE = #{emplyrSttusCode},
            LAST_UPDT_PNTTM = CURRENT_TIMESTAMP,
            LAST_UPDUSR_ID = #{lastUpdusrId}
        WHERE ESNTL_ID = #{esntlId}
    </update>
    
    <!-- 업무사용자 권한 설정 -->
    <insert id="insertEmplyrAuthority" parameterType="map">
        INSERT INTO COMTNEMPLYRSCRTYESTBS (
            SCRTY_DTRMN_TRGET_ID,
            MBER_TY_CODE,
            AUTHOR_CODE
        ) VALUES (
            #{esntlId},
            #{mberTyCode},
            #{authorCode}
        )
        ON CONFLICT (SCRTY_DTRMN_TRGET_ID, AUTHOR_CODE) DO NOTHING
    </insert>
    
    <!-- 업무사용자 권한 삭제 -->
    <delete id="deleteEmplyrAuthority" parameterType="map">
        DELETE FROM COMTNEMPLYRSCRTYESTBS
        WHERE SCRTY_DTRMN_TRGET_ID = #{esntlId}
        AND AUTHOR_CODE = #{authorCode}
    </delete>
    
    <!-- 업무사용자 목록 조회 -->
    <select id="selectEmplyrInfoList" parameterType="map" resultType="egovframework.survey.vo.EmplyrInfoVO">
        SELECT
            u.ESNTL_ID as esntlId,
            u.EMPLYR_ID as emplyrId,
            u.USER_NM as userNm,
            u.EMAIL_ADRES as emailAdres,
            u.OFCPS_NM as ofcpsNm,
            u.EMPLYR_STTUS_CODE as emplyrSttusCode,
            u.FRST_REGIST_PNTTM as frstRegistPnttm,
            s.AUTHOR_CODE as authorCode,
            a.AUTHOR_NM as authorNm,
            s.MBER_TY_CODE as mberTyCode
        FROM COMTNEMPLYRINFO u
        LEFT JOIN COMTNEMPLYRSCRTYESTBS s ON u.ESNTL_ID = s.SCRTY_DTRMN_TRGET_ID
        LEFT JOIN COMTNAUTHORINFO a ON s.AUTHOR_CODE = a.AUTHOR_CODE
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchCondition == 'emplyrId'">
                    AND LOWER(u.EMPLYR_ID) LIKE '%' || LOWER(#{searchKeyword}) || '%'
                </when>
                <when test="searchCondition == 'userNm'">
                    AND LOWER(u.USER_NM) LIKE '%' || LOWER(#{searchKeyword}) || '%'
                </when>
                <when test="searchCondition == 'emailAdres'">
                    AND LOWER(u.EMAIL_ADRES) LIKE '%' || LOWER(#{searchKeyword}) || '%'
                </when>
                <otherwise>
                    AND (LOWER(u.EMPLYR_ID) LIKE '%' || LOWER(#{searchKeyword}) || '%' 
                      OR LOWER(u.USER_NM) LIKE '%' || LOWER(#{searchKeyword}) || '%')
                </otherwise>
            </choose>
        </if>
        <if test="searchEmplyrSttusCode != null and searchEmplyrSttusCode != ''">
            AND u.EMPLYR_STTUS_CODE = #{searchEmplyrSttusCode}
        </if>
        <if test="searchAuthorCode != null and searchAuthorCode != ''">
            AND s.AUTHOR_CODE = #{searchAuthorCode}
        </if>
        ORDER BY u.FRST_REGIST_PNTTM DESC
        <if test="pageUnit != null and firstIndex != null">
            LIMIT #{pageUnit} OFFSET #{firstIndex}
        </if>
    </select>
    
    <!-- 업무사용자 목록 총 개수 조회 -->
    <select id="selectEmplyrInfoListTotCnt" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT u.ESNTL_ID)
        FROM COMTNEMPLYRINFO u
        LEFT JOIN COMTNEMPLYRSCRTYESTBS s ON u.ESNTL_ID = s.SCRTY_DTRMN_TRGET_ID
        LEFT JOIN COMTNAUTHORINFO a ON s.AUTHOR_CODE = a.AUTHOR_CODE
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchCondition == 'emplyrId'">
                    AND LOWER(u.EMPLYR_ID) LIKE '%' || LOWER(#{searchKeyword}) || '%'
                </when>
                <when test="searchCondition == 'userNm'">
                    AND LOWER(u.USER_NM) LIKE '%' || LOWER(#{searchKeyword}) || '%'
                </when>
                <when test="searchCondition == 'emailAdres'">
                    AND LOWER(u.EMAIL_ADRES) LIKE '%' || LOWER(#{searchKeyword}) || '%'
                </when>
                <otherwise>
                    AND (LOWER(u.EMPLYR_ID) LIKE '%' || LOWER(#{searchKeyword}) || '%' 
                      OR LOWER(u.USER_NM) LIKE '%' || LOWER(#{searchKeyword}) || '%')
                </otherwise>
            </choose>
        </if>
        <if test="searchEmplyrSttusCode != null and searchEmplyrSttusCode != ''">
            AND u.EMPLYR_STTUS_CODE = #{searchEmplyrSttusCode}
        </if>
        <if test="searchAuthorCode != null and searchAuthorCode != ''">
            AND s.AUTHOR_CODE = #{searchAuthorCode}
        </if>
    </select>

</mapper> 